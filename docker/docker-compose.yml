version: "3.9"

services:
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.15.2
    container_name: croc-elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=true
      - ELASTIC_PASSWORD=${ELASTIC_PASSWORD:-elasticpass}
    ulimits:
      memlock:
        soft: -1
        hard: -1
    healthcheck:
      test: ["CMD-SHELL", "curl -k -u elastic:${ELASTIC_PASSWORD:-elasticpass} https://localhost:9200 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
    volumes:
      - elastic-data:/usr/share/elasticsearch/data
    networks:
      - croc-net
    ports:
      - "9200:9200"
      - "9300:9300"

  kibana:
    image: docker.elastic.co/kibana/kibana:8.15.2
    container_name: croc-kibana
    depends_on:
      elasticsearch:
        condition: service_healthy
    environment:
      - ELASTICSEARCH_HOSTS=https://elasticsearch:9200
      - ELASTICSEARCH_USERNAME=elastic
      - ELASTICSEARCH_PASSWORD=${ELASTIC_PASSWORD:-elasticpass}
      - SERVER_PUBLICBASEURL=${KIBANA_PUBLIC_URL:-http://localhost:5601}
    networks:
      - croc-net
    ports:
      - "5601:5601"

  wazuh-manager:
    image: wazuh/wazuh-manager:4.8.0
    container_name: croc-wazuh
    depends_on:
      elasticsearch:
        condition: service_healthy
    environment:
      - ELASTICSEARCH_USERNAME=elastic
      - ELASTICSEARCH_PASSWORD=${ELASTIC_PASSWORD:-elasticpass}
      - ELASTICSEARCH_URL=https://elasticsearch:9200
    volumes:
      - wazuh-data:/var/ossec/data
    networks:
      - croc-net
    ports:
      - "1514:1514/udp"
      - "1515:1515"
      - "55000:55000"

  filebeat:
    image: wazuh/filebeat:4.8.0
    container_name: croc-filebeat
    depends_on:
      wazuh-manager:
        condition: service_started
    environment:
      - ELASTICSEARCH_USERNAME=elastic
      - ELASTICSEARCH_PASSWORD=${ELASTIC_PASSWORD:-elasticpass}
      - ELASTICSEARCH_HOST=https://elasticsearch:9200
      - KIBANA_HOST=https://kibana:5601
    networks:
      - croc-net

  misp:
    image: harvarditsecurity/misp:2.4.185
    container_name: croc-misp
    environment:
      - MISP_FQDN=${MISP_FQDN:-misp.local}
      - MISP_BASEURL=${MISP_BASEURL:-https://misp.local}
      - MISP_ADMIN_EMAIL=${MISP_ADMIN_EMAIL:-soc@croc.local}
      - MISP_ADMIN_PASSPHRASE=${MISP_ADMIN_PASSWORD:-Croc!2025}
    volumes:
      - misp-data:/var/www/MISP
    networks:
      - croc-net
    ports:
      - "8443:443"

  thehive:
    image: strangebee/thehive:5.0.31
    container_name: croc-thehive
    environment:
      - CLUSTER_NAME=croc-hive
      - DB_JOURNAL_MODE=WAL
    depends_on:
      cassandra:
        condition: service_started
    networks:
      - croc-net
    ports:
      - "9000:9000"

  cortex:
    image: strangebee/cortex:3.1.9
    container_name: croc-cortex
    depends_on:
      thehive:
        condition: service_started
    networks:
      - croc-net
    ports:
      - "9001:9001"

  cassandra:
    image: cassandra:4.1
    container_name: croc-cassandra
    environment:
      - HEAP_NEWSIZE=128M
      - MAX_HEAP_SIZE=1024M
    networks:
      - croc-net
    volumes:
      - cassandra-data:/var/lib/cassandra

  velociraptor:
    image: velocidex/velociraptor:latest
    container_name: croc-velociraptor
    volumes:
      - velociraptor-data:/opt/velociraptor
    networks:
      - croc-net
    ports:
      - "8000:8000"
      - "8001:8001"

  crocsec-sync:
    image: python:3.11-slim
    container_name: croc-misp-sync
    depends_on:
      misp:
        condition: service_started
      wazuh-manager:
        condition: service_started
    environment:
      - MISP_URL=https://misp
      - MISP_KEY=${MISP_API_KEY:-changeme}
      - WAZUH_API=https://wazuh-manager:55000
      - WAZUH_USER=${WAZUH_USER:-wazuh}
      - WAZUH_PASS=${WAZUH_PASS:-changeme}
    command: ["/bin/sh", "-c", "pip install requests && watch -n 3600 python /opt/croc/croc-misp-sync.py"]
    volumes:
      - ./automation/croc-misp-sync.py:/opt/croc/croc-misp-sync.py:ro
    networks:
      - croc-net

  suricata:
    image: jasonish/suricata:7.0.4
    container_name: croc-suricata
    cap_add:
      - NET_ADMIN
      - NET_RAW
    volumes:
      - ./suricata/suricata.yaml:/etc/suricata/suricata.yaml:ro
    networks:
      - croc-net
    command: ["-i", "eth0"]

volumes:
  elastic-data:
  wazuh-data:
  misp-data:
  cassandra-data:
  velociraptor-data:

networks:
  croc-net:
    driver: bridge

